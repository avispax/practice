# DB 運用

## 目次

1. 前提

   1. 記載範囲について
   2. DB 利用スケジュールについて

2. DB 設計
3. DB 環境
   1. 現行 : ご参考
   2. 新お届け : ～ 10 月
   3. 新お届け : 10 月～
4. 構成管理
5. 変更管理
   1. VCS（Version Control System）
      1. 現行
      2. 新お届け : ～ 10 月
      3. 新お届け : 10 月～
   2. コミット対象
   3. コミット
      1. コミット概要
      2. コミットメッセージ例
6. デプロイ
   1. 新お届け : ～ 10 月
   2. 新お届け : 10 月～
7. 移行・データマイグレーション
   1. 開発環境初期構築
   2. 定期的な移行
   3. 本番移行

## 1. 前提

### 1.1. 記載範囲について

- DB 運用に関し、以下の観点で記載する。
  - DB 設計
  - DB 環境
  - 構成管理
  - 変更管理

### 1.2. DB 利用スケジュールについて

- 当プロジェクトにおける DB 環境、変更管理環境は、共通インフラ基盤チームにより 2021 年 10 月中旬 から順次提供される。
- 2021 年 7 月からの設計フェイズでは代替環境を BTC 自前で用意し、設計作業に使用する。
- 当資料も上記スケジュールに考慮し、共通インフラ基盤チームの提供 以前、以後 で記載を分けるものとする。

- 以降、記載として以下のように称する。
  - 「現行」 : 現行バージョンに関する記載
  - 「～ 10 月」 : 新お届けプロジェクト で 2021 年 10 月中旬 **以前** の状況
  - 「10 月～」 : 　　　　　〃　　 　 2021 年 10 月中旬 **以降** の状況

## 2. DB 設計

- 01.設計方針.md 参照（いつかは Wiki とかになるはず）

## 3. DB 環境

### 3.1. 現行 : ご参考

[■ 画像を貼り付け](aaa)

### 3.2. 新お届け（～ 10 月）

- 存在せず。  
  設計作業で色々と試してみたいなどあれば、ローカル環境などで適宜作業を行うこと。
  - ご参考 : 20 分もあれば Docker HUB などで MariaDB 環境を 0 から構築できますし、お任せします。

### 3.3. 新お届け（10 月～）

- 本番 : ？
- 検証 : 4 面（2022 年 3 月以降、順次）
  - 検証 1
  - 検証 2
  - 検証 3
  - 検証 4
- 開発
  - 暫定開発（10 月～）
  - 開発（2022 年 1 月以降を予定）

## 4. 構成管理

- やたにさんに聞いたファイル/ディレクトリを書く

## 5. 変更管理

### 5.1. VCS（Version Control System）

#### 5.1.1. 現行 : ご参考

- https://git.bigtreetc.com/iyns/

#### 5.1.2. 新お届け : ～ 10 月

- 現行の GitLab に当プロジェクト用の新規リポジトリを作成し、そちらを利用する。
- https://git.bigtreetc.com/iyns/
  - iyns-app : ソース、スクリプト等
  - iyns-spec : 仕様書、ドキュメント関連用リポジトリ（構想中）
  - 他

#### 5.1.3. 新お届け : 10 月～

- 共通インフラ基盤チーム提供 : Github Enterprise
  - 新お届けに関するリポジトリのみで構成する（iyns-app、iyns-spec、他）。  
    現行リポジトリは格納しない。

### 5.2. コミット対象

- 4. 構成管理参照

### 5.3. コミット

#### 5.3.1. コミット概要

- 作業社は、DBA に対して PullRequest を出す。  
  PullRequest には以下を記載する。  
  \*フォーマットに関しては [4.3.1. コミットメッセージ例](4.3.1.-コミットメッセージ例) 参照。
  - 対応するタスク番号、feature 番号、issues の ID など
  - 作業概要
    - 例 : xx 機能 新規作成、バグ対応 : 金額不一致、など。
  - 作業詳細
    - 行 123 : if 文の判定が誤っていた箇所を修正、など。
- DBA は、上記 PullRequest の妥当性を検証し、OK / NG を判定し、対応を行う。
  - OK の場合、開発ブランチにマージなど。  
    \*コミットフローなどは策定中
  - NG の場合、指摘事項を具体的に提示し、修正を促す。

#### 5.3.2. コミットメッセージ例

- 策定中（弥谷チームで）

### 5.4. 他

- Github の標準機能を極力利用する。

  - issues など。

- Git クライアント
  - 任意。最後はコマンド操作に回帰するので。

## 6. デプロイ

### 6.1. 新お届け : ～ 10 月

- なし

### 6.2. 新お届け : 10 月～

- Github Enterprise から AWS RDS for Oracle に対して、変更スクリプトの自動適用を行う。（理想）
  - Github Actions で実現可能かどうか。要検討。

## 7. 移行・データマイグレーション

当項目では、以下の移行・データマイグレーション作業を対象に記載する。

1. 開発環境初期構築
2. 定期的に取得する現行本番 DB を新お届けプロジェクトの開発・検証環境用に変更を行う作業。以下、「定期的な移行」と称する。
3. 本番移行

### 7.1. 開発環境初期構築

- 新お届け 10 月～ で、AWS RDS for Oracle が利用可能となるため、開発環境の初期構築を行う。
  - 現行 DB を元に新お届けプロジェクトで使用する DB スクリプトを適用し DB を構築する。
- 2022 年 3 月以降に受領する検証環境（4 面）について、初回の 1 面に関しては現行 DB からの初期構築を行う。  
  他 3 面は、初回の 1 面をコピーして構築する。

### 7.2. 定期的な移行

- 半期に一度取得する現行の本番 DB は、新お届けプロジェクトでは利用しない。

### 7.3. 本番移行

- 本番移行対応チームが検討中。
